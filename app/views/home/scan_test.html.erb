<div class="container mt-5">
  <h2 class="mb-4 text-center">üì∏ Escaneie o QR Code do Crach√°</h2>
  <div id="reader" style="width: 320px; margin: 0 auto;"></div>
  <div id="status" class="text-center mt-3 text-muted">
    Aponte a c√¢mera para o crach√°...
  </div>
  <hr class="my-4">
  <h5>Simula√ß√£o manual (para teste sem c√¢mera)</h5>
  <%= form_with url: new_acao_path, method: :get, local: true do |f| %>
    <div class="d-flex gap-2">
      <%= select_tag :participante_id, 
          options_from_collection_for_select(@participantes, :id, :nome),
          prompt: "Selecione um participante", 
          class: "form-select" %>
      <%= submit_tag "Ir para A√ß√£o", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const html5QrCode = new Html5Qrcode("reader");

    function onScanSuccess(decodedText, decodedResult) {
      console.log("QR lido:", decodedText);

      // Corrige se o QR tiver localhost ou 127.0.0.1 ‚Äî troca pelo dom√≠nio atual
      let fixedUrl = decodedText;
      if (decodedText.match(/^https?:\/\/(localhost|127\.0\.0\.1)(:\d+)?/)) {
        fixedUrl = decodedText.replace(
          /^https?:\/\/(localhost|127\.0\.0\.1)(:\d+)?/,
          window.location.origin
        );
      } else if (decodedText.startsWith("/")) {
        fixedUrl = window.location.origin + decodedText;
      }

      // Se for s√≥ o ID do participante
      if (!fixedUrl.includes("participante_id=") && decodedText.match(/^\d+$/)) {
        fixedUrl = window.location.origin + "/acoes/new?participante_id=" + decodedText;
      }

      // Redireciona
      window.location.href = fixedUrl;

      html5QrCode.stop();
    }

    function onScanFailure(error) {
      // erros normais de leitura ignorados
    }

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        // tenta usar a c√¢mera traseira, se houver
        const backCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
        html5QrCode.start(
          backCamera.id,
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          onScanFailure
        );
      } else {
        document.getElementById("status").textContent = "Nenhuma c√¢mera encontrada.";
      }
    }).catch(err => {
      document.getElementById("status").textContent = "Erro ao acessar c√¢mera: " + err;
    });
  });
</script>
